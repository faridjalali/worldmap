<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>South America Map Quiz</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    
    <style>
        :root {
            --bg-deep: #0a0a0c;
            --map-stroke: rgba(255, 255, 255, 0.2);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-amber: #ffaa00;
            --glass: rgba(20, 20, 25, 0.85);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            --c-western: rgba(100, 255, 218, 0.3);
            --c-northeast: rgba(122, 142, 255, 0.3);
            --c-midwest: rgba(255, 212, 100, 0.3);
            --c-southeast: rgba(255, 100, 150, 0.3);
        }

        body {
            margin: 0; background-color: var(--bg-deep); color: white;
            font-family: var(--font-main); overflow: hidden; height: 100vh;
            width: 100vw; user-select: none; touch-action: none;
        }

        #map-stage { width: 100%; height: 100%; cursor: crosshair; }

        .state { 
            stroke: var(--map-stroke); 
            stroke-width: 0.5px; 
            transition: fill 0.3s, opacity 0.3s; 
            vector-effect: non-scaling-stroke;
            outline: none;
        }
        
        .reg-western { fill: var(--c-western); }
        .reg-northeast { fill: var(--c-northeast); }
        .reg-midwest { fill: var(--c-midwest); }
        .reg-southeast { fill: var(--c-southeast); }
        .reg-unknown { fill: #1a1a1a; }

        .state:hover { opacity: 0.8; stroke: rgba(255,255,255,0.6); }
        .state.active-focused { opacity: 1; stroke: #fff; stroke-width: 2px; }

        .state.correct-flash { animation: flashSuccess 0.5s forwards; }
        .state.wrong-flash { animation: flashError 0.5s forwards; }
        
        @keyframes flashSuccess { 0% { fill: var(--neon-green); } 100% { fill: inherit; } }
        @keyframes flashError { 0% { fill: var(--neon-pink); } 100% { fill: inherit; } }

        .city-node { 
            fill: var(--neon-blue); 
            stroke: rgba(0, 243, 255, 0.4); 
            stroke-width: 1px; 
            cursor: pointer; 
            pointer-events: none; 
        }
        .city-node.wrong-choice { fill: var(--neon-pink); stroke: var(--neon-pink); }
        .city-node.correct-choice { fill: var(--neon-green); stroke: var(--neon-green); }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        #top-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 25px; border-radius: 50px; display: flex; gap: 30px;
            backdrop-filter: blur(15px); z-index: 10; pointer-events: auto;
        }

        .hud-group { display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .hud-item { font-size: 0.6rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; }
        .hud-val { color: var(--neon-blue); font-weight: 800; font-size: 1rem; }

        #prompt-container { position: absolute; top: 120px; width: 100%; text-align: center; }
        #find-label { font-size: 0.9rem; text-transform: uppercase; color: #888; letter-spacing: 3px; margin: 0; }
        #main-prompt { font-size: 2rem; font-weight: 900; margin: 5px 0; }

        #fact-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 100; display: none; justify-content: center; align-items: center; }
        .fact-card { background: #111; border: 1px solid var(--neon-blue); padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; }
        .next-btn { background: var(--neon-blue); border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="map-stage"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div class="hud-group">
                <span class="hud-item">Target</span>
                <span id="target-state" class="hud-val">--</span>
            </div>
            <div class="hud-group">
                <span class="hud-item">Score</span>
                <span id="score-val" class="hud-val">0</span>
            </div>
        </div>
        <div id="prompt-container">
            <p id="find-label">Initializing...</p>
            <h1 id="main-prompt">Loading Map...</h1>
        </div>
    </div>

    <div id="fact-overlay">
        <div class="fact-card">
            <h2 id="fact-status">Result</h2>
            <h3 id="fact-city-name">City</h3>
            <p id="fact-text"></p>
            <button class="next-btn" onclick="nextRound()">Continue</button>
        </div>
    </div>

    <script>
        const gameData = {
            "ARG": { "name": "Argentina", "region": "southeast", "capital": "Buenos Aires", "cities": { "Buenos Aires": [-58.38, -34.60], "Córdoba": [-64.18, -31.41] }, "facts": { "Buenos Aires": "Known as the Paris of the South." }},
            "BRA": { "name": "Brazil", "region": "midwest", "capital": "Brasília", "cities": { "Brasília": [-47.88, -15.79], "Rio de Janeiro": [-43.17, -22.90] }, "facts": { "Brasília": "A planned city built in the shape of an airplane." }},
            "CHL": { "name": "Chile", "region": "western", "capital": "Santiago", "cities": { "Santiago": [-70.64, -33.44] }, "facts": { "Santiago": "Nestled in the heart of the Andes." }},
            "COL": { "name": "Colombia", "region": "northeast", "capital": "Bogotá", "cities": { "Bogotá": [-74.07, 4.71] }, "facts": { "Bogotá": "High altitude city famous for its gold museum." }},
            "PER": { "name": "Peru", "region": "western", "capital": "Lima", "cities": { "Lima": [-77.04, -12.04] }, "facts": { "Lima": "A culinary world capital on the Pacific coast." }},
            "VEN": { "name": "Venezuela", "region": "northeast", "capital": "Caracas", "cities": { "Caracas": [-66.90, 10.48] }, "facts": { "Caracas": "Located in a valley near the Caribbean Sea." }},
            "BOL": { "name": "Bolivia", "region": "western", "capital": "La Paz", "cities": { "La Paz": [-68.11, -16.48] }, "facts": { "La Paz": "The highest administrative capital in the world." }},
            "ECU": { "name": "Ecuador", "region": "western", "capital": "Quito", "cities": { "Quito": [-78.46, -0.18] }, "facts": { "Quito": "The capital city closest to the equator." }},
            "PRY": { "name": "Paraguay", "region": "midwest", "capital": "Asunción", "cities": { "Asunción": [-57.57, -25.26] }, "facts": { "Asunción": "One of the oldest cities in South America." }},
            "URY": { "name": "Uruguay", "region": "southeast", "capital": "Montevideo", "cities": { "Montevideo": [-56.16, -34.90] }, "facts": { "Montevideo": "Consistently ranked for its high quality of life." }},
            "GUY": { "name": "Guyana", "region": "northeast", "capital": "Georgetown", "cities": { "Georgetown": [-58.15, 6.80] }, "facts": { "Georgetown": "Famous for its wooden St. George's Cathedral." }},
            "SUR": { "name": "Suriname", "region": "northeast", "capital": "Paramaribo", "cities": { "Paramaribo": [-55.20, 5.85] }, "facts": { "Paramaribo": "A UNESCO World Heritage site known for its Dutch architecture." }}
        };

        let svg, g, projection, path, currentScale = 1;
        let currentTarget = "", score = 0, visited = new Set();

        window.onload = async () => {
            const width = window.innerWidth, height = window.innerHeight;
            svg = d3.select("#map-stage").append("svg").attr("viewBox", `0 0 ${width} ${height}`);
            g = svg.append("g");

            try {
                // Fetching world map data
                const response = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
                if (!response.ok) throw new Error("Network error");
                const world = await response.json();
                
                const countries = topojson.feature(world, world.objects.countries).features;
                const saFeatures = countries.filter(d => gameData[d.id] || d.properties.name === "French Guiana");

                projection = d3.geoMercator().fitSize([width, height * 0.8], { type: "FeatureCollection", features: saFeatures });
                path = d3.geoPath().projection(projection);

                g.selectAll("path").data(saFeatures).enter().append("path")
                    .attr("d", path)
                    .attr("class", d => gameData[d.id] ? `state reg-${gameData[d.id].region}` : "state reg-unknown")
                    .attr("id", d => `state-${d.id}`)
                    .on("click", (e, d) => handleStateClick(e, d));

                startRound();
            } catch (err) {
                document.getElementById("main-prompt").innerText = "Map Error: Open via local server";
                console.error(err);
            }
        };

        function startRound() {
            const keys = Object.keys(gameData);
            const available = keys.filter(k => !visited.has(k));
            if (available.length === 0) { visited.clear(); startRound(); return; }

            currentTarget = available[Math.floor(Math.random() * available.length)];
            visited.add(currentTarget);
            
            d3.selectAll(".state").classed("active-focused", false);
            d3.selectAll(".city-node").remove();
            
            document.getElementById("find-label").innerText = "Locate Country";
            document.getElementById("main-prompt").innerText = gameData[currentTarget].name;
            document.getElementById("target-state").innerText = currentTarget;
        }

        function handleStateClick(e, d) {
            if (d.id === currentTarget) {
                score += 10;
                document.getElementById("score-val").innerText = score;
                d3.select(`#state-${d.id}`).classed("active-focused", true);
                
                // Transition to city phase
                const data = gameData[d.id];
                document.getElementById("find-label").innerText = "Find Capital";
                document.getElementById("main-prompt").innerText = data.capital;
                
                const coords = projection(data.cities[data.capital]);
                g.append("circle").attr("class", "city-node")
                    .attr("cx", coords[0]).attr("cy", coords[1]).attr("r", 8)
                    .on("click", () => {
                        document.getElementById("fact-status").innerText = "Correct!";
                        document.getElementById("fact-city-name").innerText = data.capital;
                        document.getElementById("fact-text").innerText = data.facts[data.capital];
                        document.getElementById("fact-overlay").style.display = "flex";
                    })
                    .style("pointer-events", "auto");
            } else {
                d3.select(e.target).classed("wrong-flash", true);
                setTimeout(() => d3.select(e.target).classed("wrong-flash", false), 500);
                score -= 2;
                document.getElementById("score-val").innerText = score;
            }
        }

        function nextRound() {
            document.getElementById("fact-overlay").style.display = "none";
            startRound();
        }
    </script>
</body>
</html>
