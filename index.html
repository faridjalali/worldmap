<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>South America Map Quiz</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
    <style>
        :root {
            --bg-deep: #0a0a0c;
            --map-stroke: rgba(255, 255, 255, 0.2);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-amber: #ffaa00;
            --glass: rgba(20, 20, 25, 0.8);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Regional Colors */
            --c-western: rgba(100, 255, 218, 0.3);
            --c-northeast: rgba(122, 142, 255, 0.3);
            --c-midwest: rgba(255, 212, 100, 0.3);
            --c-southeast: rgba(255, 100, 150, 0.3);
        }

        body {
            margin: 0; background-color: var(--bg-deep); color: white;
            font-family: var(--font-main); overflow: hidden; height: 100vh;
            width: 100vw; user-select: none; touch-action: none; box-sizing: border-box;
        }

        #map-stage { width: 100%; height: 100%; cursor: crosshair; }

        .state { 
            stroke: var(--map-stroke); 
            stroke-width: 1px; 
            transition: fill 0.3s, opacity 0.3s; 
            vector-effect: non-scaling-stroke;
            outline: none;
        }
        
        /* Region Styling based on Game Data */
        .reg-western { fill: var(--c-western); }
        .reg-northeast { fill: var(--c-northeast); }
        .reg-midwest { fill: var(--c-midwest); }
        .reg-southeast { fill: var(--c-southeast); }
        .reg-unknown { fill: #222; }

        .state:hover { opacity: 0.8; stroke: rgba(255,255,255,0.6); }
        .state.active-focused { opacity: 1; stroke: #fff; stroke-width: 2.5px; }

        .state.correct-flash { animation: flashSuccess 0.5s forwards; }
        .state.wrong-flash { animation: flashError 0.5s forwards; }
        
        @keyframes flashSuccess { 0% { fill: var(--neon-green); } 100% { fill: inherit; } }
        @keyframes flashError { 0% { fill: var(--neon-pink); } 100% { fill: inherit; } }

        .city-node { 
            fill: var(--neon-blue); 
            stroke: rgba(0, 243, 255, 0.4); 
            stroke-width: 2px; 
            cursor: pointer; 
            transition: all 0.2s; 
            pointer-events: none; 
        }
        .city-node:hover { fill: #fff; transform: scale(1.2); }
        .city-node.wrong-choice { fill: var(--neon-pink); stroke: var(--neon-pink); }
        .city-node.correct-choice { fill: var(--neon-green); stroke: var(--neon-green); }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        #top-hud {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 30px; border-radius: 50px; display: flex; gap: 40px;
            backdrop-filter: blur(15px); z-index: 10; pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .hud-group { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
        .hud-item { font-size: 0.65rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 2px; }
        .hud-val { color: var(--neon-blue); font-weight: 800; font-size: 1.1rem; }

        .toggle-container { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .toggle-switch { width: 36px; height: 18px; background: #333; border-radius: 20px; position: relative; margin-top: 4px; border: 1px solid #444; }
        .toggle-knob { width: 14px; height: 14px; background: white; border-radius: 50%; position: absolute; top: 1px; left: 2px; transition: 0.3s; }
        .active .toggle-switch { background: var(--neon-blue); }
        .active .toggle-knob { left: 18px; }

        #prompt-container { position: absolute; top: 140px; width: 100%; text-align: center; text-shadow: 0 4px 15px rgba(0,0,0,0.8); }
        #find-label { font-size: 1rem; text-transform: uppercase; color: #aaa; letter-spacing: 4px; margin: 0; }
        #main-prompt { font-size: 2.2rem; font-weight: 900; margin: 5px 0 0; letter-spacing: 1px; }
        #sub-prompt { font-size: 1rem; color: var(--neon-amber); margin-top: 8px; font-weight: 600; }

        #city-tooltip { position: absolute; background: #000; border: 1px solid var(--neon-blue); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; pointer-events: none; opacity: 0; z-index: 100; transform: translate(-50%, -130%); }

        #fact-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #fact-overlay.show { opacity: 1; pointer-events: auto; }
        .fact-card { background: #15151a; border: 1px solid var(--neon-blue); border-radius: 20px; padding: 40px; max-width: 450px; width: 85%; text-align: center; box-shadow: 0 0 50px rgba(0,243,255,0.15); }
        .fact-status { font-weight: 800; letter-spacing: 3px; margin-bottom: 10px; text-transform: uppercase; }
        .status-correct { color: var(--neon-green); }
        .status-wrong { color: var(--neon-pink); }
        .fact-city { font-size: 2.2rem; margin: 10px 0; color: white; font-weight: 900; }
        .fact-body { color: #ccc; line-height: 1.6; margin-bottom: 30px; font-size: 1rem; }
        .next-btn { background: var(--neon-blue); color: #000; border: none; padding: 14px 40px; font-weight: 800; border-radius: 30px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="city-tooltip">City</div>
    <div id="map-stage"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div class="hud-group">
                <span class="hud-item">Target</span>
                <span id="target-state" class="hud-val">--</span>
            </div>
            <div class="hud-group">
                <span class="hud-item">Score</span>
                <span id="score-val" class="hud-val">0</span>
            </div>
            <div class="hud-group toggle-container active" id="mode-toggle" onclick="toggleMode()">
                <span class="hud-item" id="mode-label">Capital</span>
                <div class="toggle-switch"><div class="toggle-knob"></div></div>
            </div>
        </div>
        <div id="prompt-container">
            <p id="find-label">Initializing System...</p>
            <h1 id="main-prompt">South America Quiz</h1>
            <div id="sub-prompt"></div>
        </div>
    </div>

    <div id="fact-overlay">
        <div class="fact-card">
            <div class="fact-status" id="fact-status">Result</div>
            <div class="fact-city" id="fact-city-name">City</div>
            <div class="fact-body" id="fact-text">Fact</div>
            <button class="next-btn" id="next-action-btn">Continue</button>
        </div>
    </div>

    <script>
        // --- DATASET ---
        const gameData = {
            "ARG": { "name": "Argentina", "region": "southeast", "capital": "Buenos Aires", "cities": { "Buenos Aires": [-58.38, -34.60], "Córdoba": [-64.18, -31.41], "Rosario": [-60.63, -32.94] }, "facts": { "Buenos Aires": "Known as the 'Paris of South America'.", "Córdoba": "Home to the oldest university in the country.", "Rosario": "The birthplace of Che Guevara and Lionel Messi." }},
            "BRA": { "name": "Brazil", "region": "midwest", "capital": "Brasília", "cities": { "Brasília": [-47.88, -15.79], "Rio de Janeiro": [-43.17, -22.90], "São Paulo": [-46.63, -23.55] }, "facts": { "Brasília": "A planned city built in the shape of an airplane.", "Rio de Janeiro": "Famous for its Carnival and Christ the Redeemer statue.", "São Paulo": "The largest city in South America by population." }},
            "CHL": { "name": "Chile", "region": "western", "capital": "Santiago", "cities": { "Santiago": [-70.64, -33.44], "Valparaíso": [-71.61, -33.04] }, "facts": { "Santiago": "Surrounded by the Andes, visible from almost anywhere in the city.", "Valparaíso": "A coastal city known for its colorful hills and funiculars." }},
            "COL": { "name": "Colombia", "region": "northeast", "capital": "Bogotá", "cities": { "Bogotá": [-74.07, 4.71], "Medellín": [-75.56, 6.24] }, "facts": { "Bogotá": "Situated at an average of 2,640 meters above sea level.", "Medellín": "Transformed from 'most dangerous' to an award-winning innovative hub." }},
            "PER": { "name": "Peru", "region": "western", "capital": "Lima", "cities": { "Lima": [-77.04, -12.04], "Cusco": [-71.96, -13.53] }, "facts": { "Lima": "Known as the Gastronomy Capital of the world.", "Cusco": "The former capital of the Inca Empire." }},
            "VEN": { "name": "Venezuela", "region": "northeast", "capital": "Caracas", "cities": { "Caracas": [-66.90, 10.48], "Maracaibo": [-71.64, 10.64] }, "facts": { "Caracas": "Nestled in a valley separated from the Caribbean by the El Ávila mountain.", "Maracaibo": "Located near the bridge over Lake Maracaibo, one of the world's longest." }},
            "BOL": { "name": "Bolivia", "region": "western", "capital": "La Paz", "cities": { "La Paz": [-68.11, -16.48], "Sucre": [-65.25, -19.03] }, "facts": { "La Paz": "The highest administrative capital in the world.", "Sucre": "The constitutional capital, known as the 'White City'." }},
            "ECU": { "name": "Ecuador", "region": "western", "capital": "Quito", "cities": { "Quito": [-78.46, -0.18], "Guayaquil": [-79.90, -2.18] }, "facts": { "Quito": "The first city ever to be named a UNESCO World Heritage site.", "Guayaquil": "The nation's main port and largest city." }},
            "PRY": { "name": "Paraguay", "region": "midwest", "capital": "Asunción", "cities": { "Asunción": [-57.57, -25.26] }, "facts": { "Asunción": "One of the oldest cities in South America, founded in 1537." }},
            "URY": { "name": "Uruguay", "region": "southeast", "capital": "Montevideo", "cities": { "Montevideo": [-56.16, -34.90] }, "facts": { "Montevideo": "Consistently ranked as having the highest quality of life in Latin America." }},
            "GUY": { "name": "Guyana", "region": "northeast", "capital": "Georgetown", "cities": { "Georgetown": [-58.15, 6.80] }, "facts": { "Georgetown": "Known for its unique wooden colonial architecture." }},
            "SUR": { "name": "Suriname", "region": "northeast", "capital": "Paramaribo", "cities": { "Paramaribo": [-55.20, 5.85] }, "facts": { "Paramaribo": "Known for its diverse mix of Dutch and local architecture." }}
        };

        // --- GAME ENGINE ---
        let svg, g, zoom, projection, path;
        let width, height, currentScale = 1;
        let currentTargetISO = "", currentPhase = "MAP_SELECTION", targetCityName = "";
        let score = 0, isCapitalMode = true, visited = new Set();

        window.onload = init;

        async function init() {
            width = window.innerWidth;
            height = window.innerHeight;
            
            svg = d3.select("#map-stage").append("svg")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");
            
            g = svg.append("g");

            zoom = d3.zoom().scaleExtent([1, 15]).on("zoom", (e) => {
                g.attr("transform", e.transform);
                currentScale = e.transform.k;
                d3.selectAll(".city-node").attr("r", 6 / currentScale).attr("stroke-width", 2/currentScale);
            });
            svg.call(zoom);

            try {
                // Fetch World Atlas (ISO-3 codes are in properties.iso_a3 or id)
                const world = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
                const countries = topojson.feature(world, world.objects.countries).features;
                
                // Filter for SA countries
                const saFeatures = countries.filter(d => gameData[d.id] || d.properties.name === "French Guiana");

                projection = d3.geoMercator().fitSize([width, height * 0.8], { type: "FeatureCollection", features: saFeatures });
                path = d3.geoPath().projection(projection);

                g.selectAll("path")
                    .data(saFeatures)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", d => {
                        const data = gameData[d.id];
                        return data ? `state reg-${data.region}` : "state reg-unknown";
                    })
                    .attr("id", d => `state-${d.id}`)
                    .on("click", handleStateClick);

                startRound();
            } catch (err) { console.error(err); }
        }

        function startRound() {
            const available = Object.keys(gameData).filter(k => !visited.has(k));
            if (available.length === 0) { 
                alert(`Game Over! Final Score: ${score}`); 
                visited.clear(); score = 0; updateScoreUI();
            }

            currentTargetISO = available[Math.floor(Math.random() * available.length)];
            visited.add(currentTargetISO);
            
            currentPhase = "MAP_SELECTION";
            resetZoom();
            d3.selectAll(".state").classed("active-focused", false);
            d3.selectAll(".city-node").remove();
            document.getElementById("fact-overlay").classList.remove("show");

            document.getElementById("find-label").innerText = "Identify Country";
            document.getElementById("main-prompt").innerText = gameData[currentTargetISO].name;
            document.getElementById("target-state").innerText = currentTargetISO;
            document.getElementById("sub-prompt").innerText = "";
        }

        function handleStateClick(event, d) {
            if (currentPhase !== "MAP_SELECTION") return;
            const clickedISO = d.id;

            if (clickedISO === currentTargetISO) {
                score += 10; updateScoreUI();
                flashState(this, "correct");
                transitionToCityPhase(d, clickedISO);
            } else {
                score -= 5; updateScoreUI();
                flashState(this, "wrong");
                const wrongName = gameData[clickedISO] ? gameData[clickedISO].name : "Unknown Territory";
                document.getElementById("sub-prompt").innerText = `That's ${wrongName}. Try again!`;
            }
        }

        function transitionToCityPhase(geoData, iso) {
            currentPhase = "CITY_SELECTION";
            const data = gameData[iso];
            zoomToFeature(geoData);
            d3.select(`#state-${iso}`).classed("active-focused", true);
            
            document.getElementById("find-label").innerText = "Locate City";
            if (isCapitalMode) {
                targetCityName = data.capital;
                document.getElementById("main-prompt").innerText = `Capital: ${targetCityName}`;
            } else {
                const cities = Object.keys(data.cities);
                targetCityName = cities[Math.floor(Math.random() * cities.length)];
                document.getElementById("main-prompt").innerText = "Find the City";
                document.getElementById("sub-prompt").innerText = data.facts[targetCityName];
            }
            
            plotCities(iso);
        }

        function plotCities(iso) {
            const cities = gameData[iso].cities;
            const nodes = Object.entries(cities).map(([name, coords]) => {
                const pos = projection(coords);
                return { name, x: pos[0], y: pos[1] };
            });

            g.selectAll(".city-node").data(nodes).enter().append("circle")
                .attr("class", "city-node")
                .attr("cx", d => d.x).attr("cy", d => d.y)
                .attr("r", 0)
                .on("mouseover", (e, d) => {
                    const tt = document.getElementById("city-tooltip");
                    tt.innerText = d.name; tt.style.opacity = 1;
                    tt.style.left = e.pageX + "px"; tt.style.top = e.pageY + "px";
                })
                .on("mouseout", () => document.getElementById("city-tooltip").style.opacity = 0)
                .on("click", (e, d) => {
                    if (d.name === targetCityName) {
                        score += 20; updateScoreUI();
                        showFact(d.name, iso, "EXCELLENT", "status-correct");
                    } else {
                        score -= 10; updateScoreUI();
                        showFact(d.name, iso, "INCORRECT", "status-wrong");
                    }
                })
                .transition().duration(500).attr("r", 6 / currentScale)
                .style("pointer-events", "auto");
        }

        function showFact(cityName, iso, status, cssClass) {
            const overlay = document.getElementById("fact-overlay");
            document.getElementById("fact-status").innerText = status;
            document.getElementById("fact-status").className = `fact-status ${cssClass}`;
            document.getElementById("fact-city-name").innerText = cityName;
            document.getElementById("fact-text").innerText = gameData[iso].facts[cityName] || "No data available for this location.";
            
            const btn = document.getElementById("next-action-btn");
            btn.onclick = () => { overlay.classList.remove("show"); startRound(); };
            overlay.classList.add("show");
        }

        function toggleMode() {
            if (currentPhase === "CITY_SELECTION") return;
            isCapitalMode = !isCapitalMode;
            document.getElementById("mode-toggle").classList.toggle("active");
            document.getElementById("mode-label").innerText = isCapitalMode ? "Capital" : "Fact";
        }

        function updateScoreUI() { document.getElementById("score-val").innerText = score; }
        function flashState(el, type) { d3.select(el).classed(type+"-flash", true); setTimeout(() => d3.select(el).classed(type+"-flash", false), 500); }
        function resetZoom() { svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity); }
        function zoomToFeature(d) {
            const bounds = path.bounds(d);
            const dx = bounds[1][0] - bounds[0][0], dy = bounds[1][1] - bounds[0][1];
            const x = (bounds[0][0] + bounds[1][0]) / 2, y = (bounds[0][1] + bounds[1][1]) / 2;
            const scale = Math.max(1, Math.min(10, 0.7 / Math.max(dx / width, dy / height)));
            const translate = [width / 2 - scale * x, height / 2 - scale * y];
            svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }
    </script>
</body>
</html>
