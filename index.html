<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World Maps Quiz | Leaflet Engine</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; background-color: #050505; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #map { width: 100vw; height: 100vh; background: #050505; }

        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
        
        #top-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 15, 15, 0.9); border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 40px; border-radius: 50px; display: flex; gap: 50px;
            backdrop-filter: blur(10px); pointer-events: auto;
        }

        .hud-item { text-align: center; }
        .hud-label { display: block; font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 2px; }
        .hud-val { color: #00f3ff; font-weight: 800; font-size: 1.4rem; }

        #prompt-container { 
            position: absolute; top: 15%; width: 100%; text-align: center; 
            text-shadow: 0 4px 15px black; pointer-events: none;
        }
        #main-prompt { font-size: 2.5rem; color: white; font-weight: 900; margin: 0; }
        #sub-prompt { font-size: 1.2rem; color: #00f3ff; margin-top: 10px; font-weight: 600; }

        /* Mode Toggle */
        .toggle-btn {
            background: #333; border: 1px solid #555; color: white;
            padding: 5px 15px; border-radius: 20px; cursor: pointer;
            font-size: 0.8rem; text-transform: uppercase; margin-top: 5px;
        }
        .toggle-btn.active { background: #00f3ff; color: black; border-color: #00f3ff; font-weight: bold; }

        /* Fact Card */
        #fact-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000;
        }
        #fact-overlay.show { opacity: 1; pointer-events: auto; }
        
        .fact-card {
            background: #111; border: 2px solid #00f3ff; border-radius: 20px; 
            padding: 40px; max-width: 500px; width: 90%; text-align: center; color: white;
        }
        .fact-title { font-size: 2rem; margin: 0 0 20px; color: #fff; }
        .fact-text { font-size: 1.1rem; line-height: 1.6; color: #ccc; margin-bottom: 30px; }
        .next-btn {
            background: #00f3ff; color: black; border: none; padding: 15px 40px;
            font-size: 1rem; font-weight: bold; border-radius: 30px; cursor: pointer;
        }
        .next-btn:hover { transform: scale(1.05); background: white; }

        /* City Marker Styles */
        .city-marker {
            background: #00f3ff;
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            box-shadow: 0 0 10px #00f3ff;
            transition: all 0.3s;
        }
        .city-marker:hover {
            background: white;
            width: 12px !important; height: 12px !important;
            margin-left: -6px !important; margin-top: -6px !important;
        }
    </style>

    <script>const gameData = {};</script>
    <script src="north_america.js"></script>
    <script src="south_america.js"></script>
    <script src="europe.js"></script>
    <script src="africa.js"></script>
    <script src="asia.js"></script>
    <script src="oceania.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <div id="map"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div class="hud-item">
                <span class="hud-label">Score</span>
                <span id="score-val" class="hud-val">0</span>
            </div>
            <div class="hud-item" onclick="toggleMode()">
                <span class="hud-label">Mode</span>
                <button id="mode-btn" class="toggle-btn active">Capital</button>
            </div>
        </div>
        <div id="prompt-container">
            <h1 id="main-prompt">Loading World Data...</h1>
            <div id="sub-prompt"></div>
        </div>
    </div>

    <div id="fact-overlay">
        <div class="fact-card">
            <h2 class="fact-title" id="fact-city">City</h2>
            <p class="fact-text" id="fact-desc">Description</p>
            <button class="next-btn" onclick="nextRound()">Next Country</button>
        </div>
    </div>

    <script>
        let map, geoJsonLayer;
        let currentTargetISO = null;
        let currentPhase = "MAP"; // MAP or CITY
        let score = 0;
        let visited = new Set();
        let isCapitalMode = true;
        let cityMarkers = [];
        let targetCityName = "";

        // Continent Colors
        const regionColors = {
            "north_america": "#4facfe",
            "south_america": "#ff5e62",
            "europe": "#43e97b",
            "africa": "#fa709a", // Orange-Pink
            "asia": "#f09819",
            "oceania": "#a18cd1"
        };

        window.onload = initMap;

        async function initMap() {
            // 1. Initialize Leaflet
            map = L.map('map', {
                center: [20, 0],
                zoom: 2,
                zoomControl: false,
                attributionControl: false,
                minZoom: 2,
                maxZoom: 10,
                maxBounds: [[-90, -180], [90, 180]]
            });

            // 2. Load Robust GeoJSON (matches ISO Codes like "USA", "FRA")
            const response = await fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json');
            const data = await response.json();

            // 3. Style and Logic Layer
            geoJsonLayer = L.geoJson(data, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);

            startGame();
        }

        function styleFeature(feature) {
            // THE FIX: Direct ISO Lookup. No name matching.
            const iso = feature.id; 
            const entry = gameData[iso];
            
            // If country exists in your .js file, color it. If not, make it dark grey.
            if (entry) {
                return {
                    fillColor: regionColors[entry.region],
                    weight: 1, // Visible border
                    opacity: 1,
                    color: 'rgba(255,255,255,0.3)', // Border color
                    fillOpacity: 0.4
                };
            } else {
                return {
                    fillColor: "#1a1a1a",
                    weight: 0.5,
                    color: '#333',
                    fillOpacity: 1
                };
            }
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: (e) => {
                    const layer = e.target;
                    // Only highlight if it's a playable country
                    if(gameData[feature.id]) {
                        layer.setStyle({
                            weight: 2,
                            color: '#fff',
                            fillOpacity: 0.7
                        });
                        layer.bringToFront();
                    }
                },
                mouseout: (e) => {
                    geoJsonLayer.resetStyle(e.target);
                },
                click: (e) => handleCountryClick(feature.id, layer)
            });
        }

        function startGame() {
            const keys = Object.keys(gameData);
            const available = keys.filter(k => !visited.has(k));

            if (available.length === 0) {
                alert("Game Over! Score: " + score);
                visited.clear();
                score = 0;
            }

            currentTargetISO = available[Math.floor(Math.random() * available.length)];
            visited.add(currentTargetISO);
            currentPhase = "MAP";
            
            // Reset View
            map.setView([20, 0], 2);
            clearCities();
            document.getElementById('fact-overlay').classList.remove('show');
            
            // UI Update
            document.getElementById('main-prompt').innerText = gameData[currentTargetISO].name;
            document.getElementById('sub-prompt').innerText = "Find this country";
            document.getElementById('score-val').innerText = score;
        }

        function handleCountryClick(iso, layer) {
            if (currentPhase !== "MAP") return;

            if (iso === currentTargetISO) {
                score += 10;
                flashMessage("Correct!", "#00ff9d");
                transitionToCity(iso, layer);
            } else {
                score -= 5;
                const clickedName = gameData[iso] ? gameData[iso].name : "Unknown";
                flashMessage(`Wrong! That is ${clickedName}`, "#ff0055");
            }
            document.getElementById('score-val').innerText = score;
        }

        function transitionToCity(iso, layer) {
            currentPhase = "CITY";
            const data = gameData[iso];
            
            // Zoom to country
            map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 6 });

            // Setup Question
            if (isCapitalMode) {
                targetCityName = data.capital;
                document.getElementById('main-prompt').innerText = `Find Capital: ${data.capital}`;
                document.getElementById('sub-prompt').innerText = data.name;
            } else {
                // Fact mode
                const cities = Object.keys(data.cities);
                targetCityName = cities[Math.floor(Math.random() * cities.length)];
                document.getElementById('main-prompt').innerText = "Find the city matching this fact:";
                document.getElementById('sub-prompt').innerText = `"${data.facts[targetCityName]}"`;
            }

            // Plot Cities
            Object.entries(data.cities).forEach(([city, coords]) => {
                // GeoJSON is Lon/Lat, Leaflet is Lat/Lon
                const latLng = [coords[1], coords[0]]; 
                
                const marker = L.circleMarker(latLng, {
                    radius: 5, // Small base radius
                    fillColor: "#00f3ff",
                    color: "#fff",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8,
                    className: 'city-marker' // Custom CSS class for hover
                }).addTo(map);

                marker.on('click', () => handleCityClick(city, iso));
                marker.bindTooltip(city, { permanent: false, direction: 'top' });
                cityMarkers.push(marker);
            });
        }

        function handleCityClick(city, iso) {
            const data = gameData[iso];
            if (city === targetCityName) {
                score += 20;
                showFactOverlay(city, data.facts[city], true);
            } else {
                score -= 10;
                flashMessage("Wrong city!", "#ff0055");
            }
            document.getElementById('score-val').innerText = score;
        }

        function showFactOverlay(city, fact, isCorrect) {
            document.getElementById('fact-city').innerText = city;
            document.getElementById('fact-desc').innerText = fact;
            document.getElementById('fact-overlay').classList.add('show');
        }

        function nextRound() {
            startGame();
        }

        function clearCities() {
            cityMarkers.forEach(m => map.removeLayer(m));
            cityMarkers = [];
        }

        function toggleMode() {
            if (currentPhase !== "MAP") return;
            isCapitalMode = !isCapitalMode;
            const btn = document.getElementById('mode-btn');
            btn.innerText = isCapitalMode ? "Capital" : "Fact";
            btn.classList.toggle('active');
        }

        function flashMessage(text, color) {
            const sub = document.getElementById('sub-prompt');
            const original = sub.innerText;
            sub.innerText = text;
            sub.style.color = color;
            setTimeout(() => {
                sub.innerText = original;
                sub.style.color = "#00f3ff";
            }, 1500);
        }
    </script>
</body>
</html>
