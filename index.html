<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maps Quiz | World Edition</title>
    
    <link rel="icon" href="icon_0.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="icon_0.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
    <script>const gameData = {};</script>
    <script src="africa.js"></script>
    <script src="asia.js"></script>
    <script src="europe.js"></script>
    <script src="north_america.js"></script>
    <script src="south_america.js"></script>
    <script src="oceania.js"></script>
    
    <style>
        :root {
            --bg-deep: #050505;
            --map-stroke: rgba(255, 255, 255, 0.12);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-amber: #ffaa00;
            --glass: rgba(15, 15, 15, 0.85);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Regional Colors (40% Opacity) */
            --c-na: rgba(153, 204, 255, 0.40); /* North America - Light Blue */
            --c-sa: rgba(255, 153, 153, 0.40); /* South America - Light Red */
            --c-eu: rgba(153, 255, 153, 0.40); /* Europe - Light Green */
            --c-as: rgba(255, 204, 153, 0.40); /* Asia - Light Orange */
            --c-af: rgba(210, 180, 140, 0.40); /* Africa - Light Brown */
            --c-oc: rgba(230, 190, 255, 0.40); /* Oceania - Purple Tint */
        }

        body {
            margin: 0; background-color: var(--bg-deep); color: white;
            font-family: var(--font-main); overflow: hidden; height: 100vh;
            width: 100vw; user-select: none; touch-action: none; padding-top: 40px; box-sizing: border-box;
        }

        #map-stage { width: 100%; height: calc(100% - 40px); cursor: crosshair; }

        .country { stroke: var(--map-stroke); stroke-width: 0.3px; transition: fill 0.3s, opacity 0.3s; vector-effect: non-scaling-stroke; fill: #222; }
        .reg-north_america { fill: var(--c-na); }
        .reg-south_america { fill: var(--c-sa); }
        .reg-europe { fill: var(--c-eu); }
        .reg-asia { fill: var(--c-as); }
        .reg-africa { fill: var(--c-af); }
        .reg-oceania { fill: var(--c-oc); }

        .country:hover { opacity: 0.8; stroke: rgba(255,255,255,0.4); }
        .country.active-focused { opacity: 1; stroke: #fff; stroke-width: 1.5px; }

        .country.correct-flash { animation: flashSuccess 0.5s forwards; }
        .country.wrong-flash { animation: flashError 0.5s forwards; }
        @keyframes flashSuccess { 0% { fill: var(--neon-green); opacity: 1; } 100% { fill: inherit; opacity: 1; } }
        @keyframes flashError { 0% { fill: var(--neon-pink); opacity: 1; } 100% { fill: inherit; opacity: 1; } }

        .city-node { fill: var(--neon-blue); stroke: rgba(0, 243, 255, 0.2); stroke-width: 4px; cursor: pointer; transition: all 0.3s; pointer-events: none; }
        .city-node:hover { fill: #fff; stroke: var(--neon-blue); stroke-width: 7px; }
        .city-node.wrong-choice { fill: var(--neon-pink); stroke: var(--neon-pink); opacity: 0.6; pointer-events: none; }
        .city-node.correct-choice { fill: var(--neon-green); stroke: var(--neon-green); }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        #top-hud {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 30px; border-radius: 50px; display: flex; gap: 40px;
            backdrop-filter: blur(15px); z-index: 10; pointer-events: auto;
        }

        .hud-group { display: flex; flex-direction: column; align-items: center; min-width: 70px; }
        .hud-item { font-size: 0.7rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 2px; }
        .hud-val { color: var(--neon-blue); font-weight: 800; font-size: 1.2rem; }

        .toggle-container { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .toggle-switch { width: 40px; height: 20px; background: #333; border-radius: 20px; position: relative; transition: 0.3s; border: 1px solid #444; }
        .toggle-knob { width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 1px; left: 2px; transition: 0.3s; }
        .active .toggle-switch { background: var(--neon-blue); }
        .active .toggle-knob { left: 21px; }

        #prompt-container { position: absolute; top: 22%; width: 100%; text-align: center; text-shadow: 0 5px 25px black; padding: 0 20px; box-sizing: border-box; }
        #find-label { font-size: 1.1rem; text-transform: uppercase; color: #888; letter-spacing: 4px; margin: 0; }
        #main-prompt { font-size: 1.6rem; font-weight: 900; margin: 5px 0 0; transition: all 0.4s; letter-spacing: 0.5px; line-height: 1.3; max-width: 800px; display: inline-block; }
        #sub-prompt { font-size: 1.1rem; color: var(--neon-blue); margin-top: 8px; letter-spacing: 1px; }

        .wrong-state-highlight { color: var(--neon-amber); font-weight: 800; }

        #city-tooltip { position: absolute; background: rgba(0,0,0,0.9); border: 1px solid var(--neon-blue); color: white; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; pointer-events: none; opacity: 0; transform: translate(-50%, -150%); white-space: nowrap; z-index: 50; }

        #fact-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #fact-overlay.show { opacity: 1; pointer-events: auto; }
        .fact-card { background: #111; border: 2px solid var(--neon-blue); border-radius: 20px; padding: 45px; max-width: 500px; width: 92%; text-align: center; }
        .fact-status { font-weight: 800; letter-spacing: 4px; margin-bottom: 12px; font-size: 1.1rem; text-transform: uppercase; }
        .status-correct { color: var(--neon-green); }
        .status-wrong { color: var(--neon-pink); }
        .fact-city { font-size: 2.6rem; margin: 0 0 15px; color: white; font-weight: 900; }
        .fact-body { color: #ddd; line-height: 1.7; margin-bottom: 35px; font-size: 1.1rem; }
        .next-btn { background: var(--neon-blue); color: #000; border: none; padding: 16px 45px; font-weight: 800; border-radius: 40px; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .next-btn:hover { background: white; transform: scale(1.05); }

        @media (max-width: 600px) {
            #top-hud { gap: 20px; padding: 10px 15px; }
            #main-prompt { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div id="city-tooltip">City Name</div>
    <div id="map-stage"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div class="hud-group">
                <span class="hud-item">Target</span>
                <span id="target-state" class="hud-val">--</span>
            </div>
            <div class="hud-group">
                <span class="hud-item">Score</span>
                <span id="score-val" class="hud-val">0</span>
            </div>
            <div class="hud-group toggle-container active" id="mode-toggle" onclick="toggleMode()">
                <span class="hud-item" id="mode-label">Capital</span>
                <div class="toggle-switch">
                    <div class="toggle-knob"></div>
                </div>
            </div>
        </div>
        <div id="prompt-container">
            <p id="find-label">Initializing...</p>
            <h1 id="main-prompt">Syncing Global Data...</h1>
            <div id="sub-prompt"></div>
        </div>
    </div>

    <div id="fact-overlay">
        <div class="fact-card">
            <div class="fact-status" id="fact-status">Result</div>
            <div class="fact-city" id="fact-city-name">City</div>
            <div class="fact-body" id="fact-text">Fact</div>
            <button class="next-btn" id="next-action-btn">Continue</button>
        </div>
    </div>

    <script>
        let svg, g, zoom, projection, path;
        let width, height;
        let currentTargetISO = "";
        let currentPhase = "MAP_SELECTION"; 
        let score = 0;
        let visited = new Set();
        let currentScale = 1;
        let isCapitalMode = true;
        let targetCityName = "";

        window.onload = initGame;

        async function initGame() {
            width = window.innerWidth;
            height = window.innerHeight;
            const container = d3.select("#map-stage");
            svg = container.append("svg").attr("viewBox", `0 0 ${width} ${height}`).attr("preserveAspectRatio", "xMidYMid meet");
            g = svg.append("g");
            
            zoom = d3.zoom().scaleExtent([1, 60]).on("zoom", (e) => {
                g.attr("transform", e.transform);
                currentScale = e.transform.k;
                d3.selectAll(".city-node").attr("r", 4 / currentScale).attr("stroke-width", (1.5/currentScale));
            });
            svg.call(zoom);

            try {
                const world = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
                // Filter out Antarctica
                const countries = topojson.feature(world, world.objects.countries).features.filter(d => d.properties.name !== "Antarctica");
                
                projection = d3.geoMercator().fitSize([width, height], {type: "FeatureCollection", features: countries});
                path = d3.geoPath().projection(projection);

                // Create a clean lookup for region class assignment
                const nameToData = {};
                Object.entries(gameData).forEach(([iso, data]) => {
                    nameToData[data.name] = data;
                });

                g.selectAll("path")
                    .data(countries)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", d => {
                        const name = d.properties.name;
                        const data = nameToData[name];
                        return data ? `country reg-${data.region}` : "country unknown";
                    })
                    .attr("id", d => {
                        const name = d.properties.name;
                        // Find the ISO key from gameData where the name matches
                        const entry = Object.entries(gameData).find(([iso, val]) => val.name === name);
                        return entry ? `country-${entry[0]}` : `country-unknown`;
                    })
                    .on("click", handleCountryClick);

                startRound();
            } catch (err) { console.error(err); }
        }

        function toggleMode() {
            if (currentPhase === "CITY_SELECTION") return;
            isCapitalMode = !isCapitalMode;
            const container = document.getElementById('mode-toggle');
            const label = document.getElementById('mode-label');
            if (isCapitalMode) { container.classList.add('active'); label.innerText = 'Capital'; }
            else { container.classList.remove('active'); label.innerText = 'Fact'; }
        }

        function startRound() {
            const keys = Object.keys(gameData);
            const available = keys.filter(k => !visited.has(k));
            if (available.length === 0) { alert("World Tour Complete!"); visited.clear(); score = 0; startRound(); return; }

            currentTargetISO = available[Math.floor(Math.random() * available.length)];
            visited.add(currentTargetISO);
            currentPhase = "MAP_SELECTION";
            resetZoom();
            d3.selectAll(".country").classed("active-focused", false);
            d3.selectAll(".city-node").remove();
            document.getElementById("fact-overlay").classList.remove("show");
            document.getElementById("find-label").innerText = "Find Country";
            document.getElementById("main-prompt").innerText = gameData[currentTargetISO].name;
            document.getElementById("target-state").innerText = currentTargetISO;
            document.getElementById("sub-prompt").innerText = "";
            updateScoreUI();
        }

        function handleCountryClick(event, d) {
            if (currentPhase !== "MAP_SELECTION") return;
            const clickedId = this.id;
            const clickedISO = clickedId ? clickedId.replace("country-", "") : null;

            if (clickedISO === currentTargetISO) {
                score += 10; updateScoreUI();
                flashState(this, "correct");
                transitionToCityPhase(d, clickedISO);
            } else {
                score -= 10; updateScoreUI();
                flashState(this, "wrong");
                const wrongName = d.properties.name || "Unknown territory";
                const targetName = gameData[currentTargetISO].name;
                document.getElementById("find-label").innerText = "Find";
                document.getElementById("main-prompt").innerText = targetName;
                document.getElementById("sub-prompt").innerHTML = `That is <span class="wrong-state-highlight">${wrongName}</span>`;
            }
        }

        function transitionToCityPhase(geoData, iso) {
            currentPhase = "CITY_SELECTION";
            zoomToCountry(geoData);
            d3.select(`#country-${iso}`).classed("active-focused", true);
            const data = gameData[iso];
            document.getElementById("find-label").innerText = "Find";
            if (isCapitalMode) {
                targetCityName = data.capital;
                document.getElementById("main-prompt").innerText = `The capital of ${data.name}`;
            } else {
                const cityNames = Object.keys(data.cities);
                targetCityName = cityNames[Math.floor(Math.random() * cityNames.length)];
                document.getElementById("main-prompt").innerText = data.facts[targetCityName];
            }
            plotCities(iso);
            setTimeout(() => { d3.selectAll(".city-node").style("pointer-events", "auto"); }, 1200);
        }

        function plotCities(iso) {
            const data = gameData[iso];
            const nodes = Object.entries(data.cities).map(([name, coords]) => {
                const projected = projection(coords);
                return projected ? { name, x: projected[0], y: projected[1] } : null;
            }).filter(n => n);
            g.selectAll(".city-node").data(nodes).enter().append("circle")
                .attr("class", "city-node").attr("cx", d => d.x).attr("cy", d => d.y).attr("r", 0)
                .on("mouseover", showTooltip).on("mousemove", moveTooltip).on("mouseout", hideTooltip)
                .on("click", (e, d) => handleCityClick(e, d, iso))
                .transition().duration(500).delay(800).attr("r", 5 / currentScale);
        }

        function handleCityClick(event, cityNode, iso) {
            const isCorrect = cityNode.name === targetCityName;
            const dot = d3.select(event.currentTarget);
            if (isCorrect) {
                dot.classed("correct-choice", true);
                score += 10; updateScoreUI();
                showFact(cityNode.name, iso, "CORRECT", "status-correct");
            } else {
                dot.classed("wrong-choice", true);
                score -= 10; updateScoreUI();
                showFact(cityNode.name, iso, "INCORRECT", "status-wrong");
            }
        }

        function showFact(cityName, iso, status, statusClass) {
            const data = gameData[iso];
            const overlay = document.getElementById("fact-overlay");
            const btn = document.getElementById("next-action-btn");
            document.getElementById("fact-status").innerText = status;
            document.getElementById("fact-status").className = `fact-status ${statusClass}`;
            document.getElementById("fact-city-name").innerText = cityName;
            document.getElementById("fact-text").innerHTML = data.facts[cityName];
            btn.innerText = (status === "CORRECT") ? "Next Country" : "Keep Searching";
            btn.onclick = (status === "CORRECT") ? resetGameRound : () => overlay.classList.remove("show");
            overlay.classList.add("show");
        }

        function updateScoreUI() { document.getElementById("score-val").innerText = score; }
        function showTooltip(e, d) { const tt = document.getElementById("city-tooltip"); tt.innerText = d.name; tt.style.opacity = 1; }
        function moveTooltip(e) { const tt = document.getElementById("city-tooltip"); tt.style.left = e.pageX + "px"; tt.style.top = e.pageY + "px"; }
        function hideTooltip() { document.getElementById("city-tooltip").style.opacity = 0; }
        function resetGameRound() { startRound(); }

        function zoomToCountry(d) {
            const b = path.bounds(d);
            const s = Math.max(1, Math.min(25, 0.7 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height)));
            const t = [width / 2 - s * (b[0][0] + b[1][0]) / 2, height / 2 - s * (b[0][1] + b[1][1]) / 2];
            svg.transition().duration(1200).call(zoom.transform, d3.zoomIdentity.translate(t[0], t[1]).scale(s));
        }

        function resetZoom() { svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity); }
        function flashState(el, type) { d3.select(el).classed(type+"-flash", true); setTimeout(() => d3.select(el).classed(type+"-flash", false), 600); }
    </script>
</body>
</html>
