<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>South America Maps Quiz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
    <style>
        :root {
            --bg-deep: #050505;
            --map-stroke: rgba(255, 255, 255, 0.15);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-amber: #ffaa00;
            --glass: rgba(15, 15, 15, 0.85);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Regional Colors */
            --c-southwest: rgba(255, 153, 153, 0.40);
            --c-western: rgba(153, 255, 153, 0.40);
            --c-northeast: rgba(153, 204, 255, 0.40);
            --c-midwest: rgba(255, 204, 153, 0.40);
            --c-southeast: rgba(210, 180, 140, 0.40);
        }

        body {
            margin: 0; background-color: var(--bg-deep); color: white;
            font-family: var(--font-main); overflow: hidden; height: 100vh;
            width: 100vw; user-select: none; touch-action: none;
        }

        #map-stage { width: 100%; height: 100%; cursor: crosshair; }

        .state { 
            stroke: var(--map-stroke); 
            stroke-width: 0.5px; 
            transition: fill 0.3s, opacity 0.3s; 
            vector-effect: non-scaling-stroke; 
        }
        
        /* Region Classes */
        .reg-western { fill: var(--c-western); }
        .reg-northeast { fill: var(--c-northeast); }
        .reg-midwest { fill: var(--c-midwest); }
        .reg-southeast { fill: var(--c-southeast); }
        .reg-unknown { fill: #222; } /* For non-game countries like French Guiana */

        .state:hover { opacity: 0.8; stroke: rgba(255,255,255,0.6); stroke-width: 1px; }
        .state.active-focused { opacity: 1; stroke: #fff; stroke-width: 2px; }

        /* Animation */
        .state.correct-flash { animation: flashSuccess 0.5s forwards; }
        .state.wrong-flash { animation: flashError 0.5s forwards; }
        @keyframes flashSuccess { 0% { fill: var(--neon-green); opacity: 1; } 100% { fill: inherit; opacity: 1; } }
        @keyframes flashError { 0% { fill: var(--neon-pink); opacity: 1; } 100% { fill: inherit; opacity: 1; } }

        .city-node { fill: var(--neon-blue); stroke: rgba(0, 243, 255, 0.2); stroke-width: 5px; cursor: pointer; pointer-events: none; transition: 0.3s; }
        .city-node:hover { fill: #fff; stroke: var(--neon-blue); stroke-width: 8px; }
        .city-node.wrong-choice { fill: var(--neon-pink); stroke: var(--neon-pink); pointer-events: none; opacity: 0.6; }
        .city-node.correct-choice { fill: var(--neon-green); stroke: var(--neon-green); }

        /* UI Overlays */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        #top-hud {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 30px; border-radius: 50px; display: flex; gap: 40px;
            backdrop-filter: blur(15px); z-index: 10; pointer-events: auto;
        }

        .hud-group { display: flex; flex-direction: column; align-items: center; min-width: 70px; }
        .hud-item { font-size: 0.7rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; }
        .hud-val { color: var(--neon-blue); font-weight: 800; font-size: 1.2rem; }

        .toggle-container { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .toggle-switch { width: 40px; height: 20px; background: #333; border-radius: 20px; position: relative; transition: 0.3s; border: 1px solid #444; }
        .toggle-knob { width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 1px; left: 2px; transition: 0.3s; }
        .active .toggle-switch { background: var(--neon-blue); }
        .active .toggle-knob { left: 21px; }

        #prompt-container { position: absolute; top: 20%; width: 100%; text-align: center; text-shadow: 0 5px 25px black; }
        #find-label { font-size: 1.2rem; text-transform: uppercase; color: #888; letter-spacing: 4px; margin: 0; }
        #main-prompt { font-size: 2rem; font-weight: 900; margin: 5px 0 0; }
        #sub-prompt { font-size: 1.1rem; color: var(--neon-blue); margin-top: 8px; }

        #fact-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #fact-overlay.show { opacity: 1; pointer-events: auto; }
        .fact-card { background: #111; border: 2px solid var(--neon-blue); border-radius: 20px; padding: 45px; max-width: 500px; width: 90%; text-align: center; }
        .fact-status { font-weight: 800; letter-spacing: 4px; margin-bottom: 12px; font-size: 1.1rem; text-transform: uppercase; }
        .status-correct { color: var(--neon-green); }
        .status-wrong { color: var(--neon-pink); }
        .fact-city { font-size: 2.2rem; margin: 0 0 15px; color: white; font-weight: 900; }
        .fact-body { color: #ddd; line-height: 1.7; margin-bottom: 35px; font-size: 1.1rem; }
        .next-btn { background: var(--neon-blue); color: #000; border: none; padding: 16px 45px; font-weight: 800; border-radius: 40px; cursor: pointer; text-transform: uppercase; }
        
        #city-tooltip { position: absolute; background: black; border: 1px solid var(--neon-blue); color: white; padding: 4px 8px; font-size: 12px; pointer-events: none; opacity: 0; z-index: 50; }
    </style>
</head>
<body>

    <div id="city-tooltip"></div>
    <div id="map-stage"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div class="hud-group">
                <span class="hud-item">Target</span>
                <span id="target-state" class="hud-val">--</span>
            </div>
            <div class="hud-group">
                <span class="hud-item">Score</span>
                <span id="score-val" class="hud-val">0</span>
            </div>
            <div class="hud-group toggle-container active" id="mode-toggle" onclick="toggleMode()">
                <span class="hud-item" id="mode-label">Capital</span>
                <div class="toggle-switch"><div class="toggle-knob"></div></div>
            </div>
        </div>
        <div id="prompt-container">
            <p id="find-label">Initializing...</p>
            <h1 id="main-prompt">Loading Map Data...</h1>
            <div id="sub-prompt"></div>
        </div>
    </div>

    <div id="fact-overlay">
        <div class="fact-card">
            <div class="fact-status" id="fact-status">Result</div>
            <div class="fact-city" id="fact-city-name">City</div>
            <div class="fact-body" id="fact-text">Fact</div>
            <button class="next-btn" id="next-action-btn">Continue</button>
        </div>
    </div>

    <script>
        // --- 1. GAME DATA (Using ISO Numeric Codes to match World Atlas) ---
        // 032: Argentina, 068: Bolivia, 076: Brazil, 152: Chile, 170: Colombia
        // 218: Ecuador, 328: Guyana, 600: Paraguay, 604: Peru, 740: Suriname
        // 858: Uruguay, 862: Venezuela
        const gameData = {
            "032": { "iso": "ARG", "name": "Argentina", "region": "southeast", "capital": "Buenos Aires", "cities": { "Buenos Aires": [-58.38, -34.60], "Córdoba": [-64.18, -31.41], "Rosario": [-60.63, -32.94] }, "facts": { "Buenos Aires": "Known as the 'Paris of South America'.", "Córdoba": "Home to the oldest university in the country.", "Rosario": "The birthplace of Che Guevara." }},
            "068": { "iso": "BOL", "name": "Bolivia", "region": "western", "capital": "La Paz", "cities": { "La Paz": [-68.11, -16.48], "Sucre": [-65.25, -19.03] }, "facts": { "La Paz": "The highest administrative capital in the world.", "Sucre": "The constitutional capital of the country." }},
            "076": { "iso": "BRA", "name": "Brazil", "region": "midwest", "capital": "Brasília", "cities": { "Brasília": [-47.88, -15.79], "Rio de Janeiro": [-43.17, -22.90], "São Paulo": [-46.63, -23.55] }, "facts": { "Brasília": "A planned city famous for its modernist architecture.", "Rio de Janeiro": "Home to the Christ the Redeemer statue.", "São Paulo": "The largest city in the Southern Hemisphere." }},
            "152": { "iso": "CHL", "name": "Chile", "region": "western", "capital": "Santiago", "cities": { "Santiago": [-70.64, -33.44], "Valparaíso": [-71.61, -33.04] }, "facts": { "Santiago": "Located in a valley surrounded by the snow-capped Andes.", "Valparaíso": "A colorful port city known for its steep funiculars." }},
            "170": { "iso": "COL", "name": "Colombia", "region": "northeast", "capital": "Bogotá", "cities": { "Bogotá": [-74.07, 4.71], "Medellín": [-75.56, 6.24] }, "facts": { "Bogotá": "One of the highest capital cities in the world.", "Medellín": "Known as the 'City of Eternal Spring'." }},
            "218": { "iso": "ECU", "name": "Ecuador", "region": "western", "capital": "Quito", "cities": { "Quito": [-78.46, -0.18], "Guayaquil": [-79.90, -2.18] }, "facts": { "Quito": "The closest capital city to the equator.", "Guayaquil": "The main port and largest city of Ecuador." }},
            "328": { "iso": "GUY", "name": "Guyana", "region": "northeast", "capital": "Georgetown", "cities": { "Georgetown": [-58.15, 6.80] }, "facts": { "Georgetown": "Known for its Dutch colonial architecture." }},
            "600": { "iso": "PRY", "name": "Paraguay", "region": "midwest", "capital": "Asunción", "cities": { "Asunción": [-57.57, -25.26] }, "facts": { "Asunción": "One of the oldest cities in South America." }},
            "604": { "iso": "PER", "name": "Peru", "region": "western", "capital": "Lima", "cities": { "Lima": [-77.04, -12.04], "Cusco": [-71.96, -13.53] }, "facts": { "Lima": "Once the capital of the Spanish Viceroyalty.", "Cusco": "The historic capital of the Inca Empire." }},
            "740": { "iso": "SUR", "name": "Suriname", "region": "northeast", "capital": "Paramaribo", "cities": { "Paramaribo": [-55.20, 5.85] }, "facts": { "Paramaribo": "A UNESCO World Heritage site." }},
            "858": { "iso": "URY", "name": "Uruguay", "region": "southeast", "capital": "Montevideo", "cities": { "Montevideo": [-56.16, -34.90] }, "facts": { "Montevideo": "Offers the highest quality of life in Latin America." }},
            "862": { "iso": "VEN", "name": "Venezuela", "region": "northeast", "capital": "Caracas", "cities": { "Caracas": [-66.90, 10.48], "Maracaibo": [-71.64, 10.64] }, "facts": { "Caracas": "Separated from the Caribbean coast by a mountain range.", "Maracaibo": "Located near the lake famous for Catatumbo lightning." }}
        };

        // --- 2. SETUP ---
        let svg, g, zoom, projection, path;
        let width, height, currentScale = 1;
        let currentTargetID = "", currentPhase = "MAP_SELECTION"; 
        let score = 0, isCapitalMode = true, visited = new Set();
        let targetCityName = "";

        window.onload = initGame;

        async function initGame() {
            width = window.innerWidth;
            height = window.innerHeight;
            const container = d3.select("#map-stage");
            svg = container.append("svg").attr("viewBox", `0 0 ${width} ${height}`).attr("preserveAspectRatio", "xMidYMid meet");
            g = svg.append("g");
            
            // Zoom behavior
            zoom = d3.zoom().scaleExtent([1, 15]).on("zoom", (e) => {
                g.attr("transform", e.transform);
                currentScale = e.transform.k;
                d3.selectAll(".city-node").attr("r", 6 / currentScale).attr("stroke-width", (2/currentScale));
                d3.selectAll(".state").attr("stroke-width", 0.5 / currentScale);
            });
            svg.call(zoom);

            try {
                // Fetch World Atlas (Standard Source)
                const response = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
                if(!response.ok) throw new Error("Failed to load map data");
                
                const world = await response.json();
                const countries = topojson.feature(world, world.objects.countries).features;
                
                // Filter specifically for South American numeric IDs (and French Guiana 254)
                // We use the keys from gameData + French Guiana (254)
                const saIds = [...Object.keys(gameData), "254"]; 
                const saFeatures = countries.filter(d => saIds.includes(d.id));

                // Projection setup - Mercator fits well for World/Continents
                projection = d3.geoMercator().fitSize([width, height * 0.9], {
                    type: "FeatureCollection", features: saFeatures
                });
                path = d3.geoPath().projection(projection);

                // Draw Paths
                g.selectAll("path")
                    .data(saFeatures)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", d => {
                        const data = gameData[d.id];
                        return data ? `state reg-${data.region}` : "state reg-unknown";
                    })
                    .attr("id", d => `state-${d.id}`)
                    .on("click", handleStateClick);

                startRound();

            } catch (err) {
                console.error(err);
                document.getElementById("main-prompt").innerText = "Error Loading Map";
                document.getElementById("sub-prompt").innerText = "Please check internet connection or CORS settings.";
            }
        }

        // --- 3. GAME LOGIC ---
        function startRound() {
            const keys = Object.keys(gameData);
            const available = keys.filter(k => !visited.has(k));
            if (available.length === 0) { 
                alert("Game Complete! Final Score: " + score); 
                visited.clear(); score = 0; startRound(); return; 
            }

            // Pick random country by ID
            currentTargetID = available[Math.floor(Math.random() * available.length)];
            visited.add(currentTargetID);
            
            currentPhase = "MAP_SELECTION";
            resetZoom();
            d3.selectAll(".state").classed("active-focused", false);
            d3.selectAll(".city-node").remove();
            document.getElementById("fact-overlay").classList.remove("show");

            const targetData = gameData[currentTargetID];
            document.getElementById("find-label").innerText = "Find Country";
            document.getElementById("main-prompt").innerText = targetData.name;
            document.getElementById("target-state").innerText = targetData.iso;
            document.getElementById("sub-prompt").innerText = ""; 
            updateScoreUI();
        }

        function handleStateClick(event, d) {
            if (currentPhase !== "MAP_SELECTION") return;
            const clickedID = d.id;
            
            // Ignore French Guiana (254) or undefined regions
            if (!gameData[clickedID]) return;

            if (clickedID === currentTargetID) {
                score += 10; updateScoreUI();
                flashState(this, "correct");
                transitionToCityPhase(d, clickedID);
            } else {
                score -= 10; updateScoreUI();
                flashState(this, "wrong");
                const wrongName = gameData[clickedID].name;
                document.getElementById("sub-prompt").innerHTML = `That is <span style="color:var(--neon-amber)">${wrongName}</span>. Try again.`;
            }
        }

        function transitionToCityPhase(geoData, id) {
            currentPhase = "CITY_SELECTION";
            zoomToState(geoData);
            d3.select(`#state-${id}`).classed("active-focused", true);
            
            const data = gameData[id];
            document.getElementById("find-label").innerText = "Find City";
            document.getElementById("sub-prompt").innerText = ""; 
            
            if (isCapitalMode) {
                targetCityName = data.capital;
                document.getElementById("main-prompt").innerText = `Capital: ${targetCityName}`;
            } else {
                const cityNames = Object.keys(data.cities);
                targetCityName = cityNames[Math.floor(Math.random() * cityNames.length)];
                document.getElementById("main-prompt").innerText = "Identify City";
                document.getElementById("sub-prompt").innerText = `"${data.facts[targetCityName]}"`;
            }
            
            plotCities(id);
            setTimeout(() => { d3.selectAll(".city-node").style("pointer-events", "auto"); }, 800);
        }

        function plotCities(id) {
            const data = gameData[id];
            const nodes = Object.entries(data.cities).map(([name, coords]) => {
                const projected = projection(coords);
                return projected ? { name, x: projected[0], y: projected[1] } : null;
            }).filter(n => n);

            g.selectAll(".city-node").data(nodes).enter().append("circle")
                .attr("class", "city-node").attr("cx", d => d.x).attr("cy", d => d.y).attr("r", 0)
                .on("mouseover", showTooltip).on("mousemove", moveTooltip).on("mouseout", hideTooltip)
                .on("click", (e, d) => handleCityClick(e, d, id))
                .transition().duration(500).delay(400).attr("r", 6 / currentScale);
        }

        function handleCityClick(event, cityNode, id) {
            const isCorrect = cityNode.name === targetCityName;
            const dot = d3.select(event.currentTarget);

            if (isCorrect) {
                dot.classed("correct-choice", true);
                score += 20; updateScoreUI();
                showFact(cityNode.name, id, "CORRECT", "status-correct");
            } else {
                dot.classed("wrong-choice", true);
                score -= 10; updateScoreUI();
                showFact(cityNode.name, id, "INCORRECT", "status-wrong");
            }
        }

        function showFact(cityName, id, status, statusClass) {
            const data = gameData[id];
            const overlay = document.getElementById("fact-overlay");
            const btn = document.getElementById("next-action-btn");
            
            document.getElementById("fact-status").innerText = status;
            document.getElementById("fact-status").className = `fact-status ${statusClass}`;
            document.getElementById("fact-city-name").innerText = cityName;
            document.getElementById("fact-text").innerText = data.facts[cityName];

            btn.innerText = (status === "CORRECT") ? "Next Country" : "Close";
            btn.onclick = (status === "CORRECT") ? resetGameRound : () => overlay.classList.remove("show");

            overlay.classList.add("show");
        }

        function toggleMode() {
            if (currentPhase === "CITY_SELECTION") return; 
            isCapitalMode = !isCapitalMode;
            document.getElementById('mode-toggle').classList.toggle('active');
            document.getElementById('mode-label').innerText = isCapitalMode ? 'Capital' : 'Fact';
        }

        function updateScoreUI() { document.getElementById("score-val").innerText = score; }
        function showTooltip(e, d) { 
            const tt = document.getElementById("city-tooltip"); 
            tt.innerText = d.name; tt.style.opacity = 1; 
            tt.style.left = (e.pageX + 10) + "px"; tt.style.top = (e.pageY - 20) + "px";
        }
        function moveTooltip(e) { 
            const tt = document.getElementById("city-tooltip"); 
            tt.style.left = (e.pageX + 10) + "px"; tt.style.top = (e.pageY - 20) + "px";
        }
        function hideTooltip() { document.getElementById("city-tooltip").style.opacity = 0; }
        function resetGameRound() { startRound(); }

        function zoomToState(d) {
            const b = path.bounds(d);
            const dx = b[1][0] - b[0][0], dy = b[1][1] - b[0][1];
            const x = (b[0][0] + b[1][0]) / 2, y = (b[0][1] + b[1][1]) / 2;
            const s = Math.max(1, Math.min(10, 0.7 / Math.max(dx / width, dy / height)));
            const t = [width / 2 - s * x, height / 2 - s * y];
            svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity.translate(t[0], t[1]).scale(s));
        }

        function resetZoom() { svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity); }
        function flashState(el, type) { d3.select(el).classed(type+"-flash", true); setTimeout(() => d3.select(el).classed(type+"-flash", false), 500); }
    </script>
</body>
</html>
